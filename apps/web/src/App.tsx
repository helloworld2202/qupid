import React, { useEffect } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { Providers } from './app/providers';
import { useUserStore } from './shared/stores/userStore';
import { useNavigationStore } from './shared/stores/navigationStore';
import { Screen, NavigationScreen } from '@qupid/core';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
});

// Shared Components
import { BottomNavBar } from './shared/components/BottomNavBar';
import { HomeScreen } from './shared/components/HomeScreen';

// Feature Components
import { OnboardingFlow } from './features/onboarding/components/OnboardingFlow';
import { ChatTabScreen } from './features/chat/components/ChatTabScreen';
import { ChatScreen } from './features/chat/components/ChatScreen';
import { ConversationPrepScreen } from './features/chat/components/ConversationPrepScreen';
import { ConversationAnalysisScreen } from './features/chat/components/ConversationAnalysisScreen';
import { PersonaDetailScreen } from './features/chat/components/PersonaDetailScreen';
import { CustomPersonaForm } from './features/chat/components/CustomPersonaForm';
import { TutorialIntroScreen } from './features/onboarding/components/TutorialIntroScreen';
import { PersonaSelection } from './features/onboarding/components/PersonaSelection';
import { PersonaRecommendationIntro } from './features/onboarding/components/PersonaRecommendationIntro';
import { CoachingTabScreen } from './features/coaching/components/CoachingTabScreen';
import { StylingCoach } from './features/coaching/components/StylingCoach';
import { LearningGoalsScreen } from './features/coaching/components/LearningGoalsScreen';
import { MyTabScreen } from './features/profile/components/MyTabScreen';
import { ProfileEditScreen } from './features/profile/components/ProfileEditScreen';
import { SettingsScreen } from './features/profile/components/SettingsScreen';
import { BadgesScreen } from './features/profile/components/BadgesScreen';
import { useBadges } from './shared/hooks/useBadges';
import { FavoritesScreen } from './features/profile/components/FavoritesScreen';
import NotificationSettingsScreen from './features/profile/components/NotificationSettingsScreen';
import { DeleteAccountScreen } from './features/profile/components/DeleteAccountScreen';
import { DesignGuideScreen } from './features/profile/components/DesignGuideScreen';
import { PerformanceDetailScreen } from './features/analytics/components/PerformanceDetailScreen';
import { DataExportScreen } from './features/analytics/components/DataExportScreen';
import { LoginScreen } from './features/auth/components/LoginScreen';
import { SignupScreen } from './features/auth/components/SignupScreen';
import AuthCallback from './features/auth/components/AuthCallback';

// Badges Container with API integration
const BadgesContainer: React.FC<{ onBack: () => void }> = ({ onBack }) => {
  const { data: badges = [], isLoading } = useBadges();
  
  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#0AC5A8]"></div>
      </div>
    );
  }
  
  return <BadgesScreen badges={badges} onBack={onBack} />;
};

const AppContent: React.FC = () => {
  const { user, setUser } = useUserStore();
  const { currentScreen, navigateTo: originalNavigateTo } = useNavigationStore();
  const [appState, setAppState] = React.useState<'loading' | 'guest' | 'auth' | 'onboarding' | 'main'>('loading');
  const [sessionData, setSessionData] = React.useState<any>(null);
  // const [favoriteIds] = React.useState<string[]>(['persona-1', 'persona-3']);
  const [previousScreen, setPreviousScreen] = React.useState<NavigationScreen>('HOME');
  const [isGuest, setIsGuest] = React.useState(false);

  // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎûòÌçº - Ïù¥Ï†Ñ ÌôîÎ©¥ Ï∂îÏ†Å
  const navigateTo = React.useCallback((screen: NavigationScreen) => {
    setPreviousScreen(currentScreen);
    originalNavigateTo(screen as any);
  }, [currentScreen, originalNavigateTo]);

  useEffect(() => {
    // ÌäúÌÜ†Î¶¨Ïñº ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    const tutorialSessionData = localStorage.getItem('tutorialSessionData');
    if (tutorialSessionData) {
      try {
        const session = JSON.parse(tutorialSessionData);
        setSessionData(session);
        console.log('ÌäúÌÜ†Î¶¨Ïñº ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®:', session);
      } catch (error) {
        console.error('ÌäúÌÜ†Î¶¨Ïñº ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', error);
      }
    }

    // Check if this is a social login callback
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const refreshToken = urlParams.get('refresh_token');
    
    if (token && refreshToken) {
      // This is a social login callback, check if we're in onboarding flow
      const isOnboardingFlow = localStorage.getItem('isOnboardingFlow') === 'true';
      
      if (isOnboardingFlow) {
        // Store tokens and continue with onboarding
        localStorage.setItem('authToken', token);
        localStorage.setItem('refreshToken', refreshToken);
        localStorage.removeItem('isOnboardingFlow');
        setAppState('onboarding');
        navigateTo('ONBOARDING');
        return;
      } else {
        // Regular social login callback
        setAppState('auth');
        navigateTo('AUTH_CALLBACK');
        return;
      }
    }

    // Check for auth token first
    const authToken = localStorage.getItem('authToken');
    const storedProfile = localStorage.getItem('userProfile');
    const guestId = localStorage.getItem('guestId');
    const hasCompletedOnboarding = localStorage.getItem('hasCompletedOnboarding');
    
    if (authToken && storedProfile) {
      // Logged in with profile
      const profile = JSON.parse(storedProfile);
      setUser(profile);
      setAppState('main');
    } else if (authToken) {
      // Logged in but no profile yet
      setAppState('onboarding');
    } else if (hasCompletedOnboarding && guestId) {
      // Guest user who completed onboarding
      const guestProfile = {
        id: guestId,
        name: 'Í≤åÏä§Ìä∏',
        user_gender: (localStorage.getItem('guestGender') || 'male') as 'male' | 'female',
        partner_gender: (localStorage.getItem('guestPartnerGender') || 'female') as 'male' | 'female',
        experience: localStorage.getItem('guestExperience') || 'ÏóÜÏùå',
        confidence: parseInt(localStorage.getItem('guestConfidence') || '3'),
        difficulty: parseInt(localStorage.getItem('guestDifficulty') || '2'),
        interests: JSON.parse(localStorage.getItem('guestInterests') || '[]'),
        isTutorialCompleted: localStorage.getItem('guestTutorialCompleted') === 'true',
        isGuest: true
      };
      setUser(guestProfile);
      setIsGuest(true);
      setAppState('main');
    } else {
      // New user - start with onboarding
      setAppState('onboarding');
      navigateTo('ONBOARDING');
    }
  }, [setUser, navigateTo]);

  const handleOnboardingComplete = (profile: any, tutorialPersona?: any) => {
    // Í≤åÏä§Ìä∏ ÌîÑÎ°úÌïÑ ÏÉùÏÑ±
    const guestId = `guest_${new Date().getTime()}`;
    const newProfile = {
      ...profile,
      id: guestId,
      name: 'Í≤åÏä§Ìä∏',
      created_at: new Date().toISOString(),
      isTutorialCompleted: false,
      isGuest: true
    };
    
    // Í≤åÏä§Ìä∏ Ï†ïÎ≥¥Î•º localStorageÏóê Ï†ÄÏû•
    localStorage.setItem('guestId', guestId);
    localStorage.setItem('guestGender', profile.user_gender);
    localStorage.setItem('guestPartnerGender', profile.partner_gender);
    localStorage.setItem('guestExperience', profile.experience);
    localStorage.setItem('guestConfidence', profile.confidence.toString());
    localStorage.setItem('guestDifficulty', profile.difficulty.toString());
    localStorage.setItem('guestInterests', JSON.stringify(profile.interests || []));
    localStorage.setItem('hasCompletedOnboarding', 'true');
    
    setUser(newProfile);
    setIsGuest(true);
    setAppState('main');
    
    // ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇòÎ•º sessionDataÏóê Ï†ÄÏû•
    console.log('üéâ Ïò®Î≥¥Îî© ÏôÑÎ£å:', profile);
    console.log('ü§ñ ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇò:', tutorialPersona);
    
    if (tutorialPersona) {
      setSessionData({ partner: tutorialPersona, isTutorial: true });
      console.log('‚úÖ Ïò®Î≥¥Îî© ÏôÑÎ£å - ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇòÏôÄ Ìï®Íªò ÌäúÌÜ†Î¶¨Ïñº ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô', tutorialPersona);
    } else {
      console.log('‚ö†Ô∏è ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇò ÏóÜÏùå - ÌäúÌÜ†Î¶¨Ïñº ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô');
    }
    
    navigateTo(Screen.TutorialIntro);
  };
  
  // ÌöåÏõêÍ∞ÄÏûÖ/Î°úÍ∑∏Ïù∏ Ïú†ÎèÑ Ìï®Ïàò
  const requireAuth = (callback?: () => void) => {
    if (isGuest) {
      // Í≤åÏä§Ìä∏ ÏÇ¨Ïö©ÏûêÏùº Í≤ΩÏö∞ ÌöåÏõêÍ∞ÄÏûÖ Ïú†ÎèÑ
      const confirmSignup = window.confirm('Ïù¥ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. ÌöåÏõêÍ∞ÄÏûÖ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
      if (confirmSignup) {
        navigateTo(Screen.SIGNUP);
      }
      return false;
    } else if (!user) {
      // Î°úÍ∑∏Ïù∏ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
      navigateTo(Screen.LOGIN);
      return false;
    }
    // Ïù∏Ï¶ùÎêú ÏÇ¨Ïö©Ïûê
    if (callback) callback();
    return true;
  };

  const renderScreen = () => {
    switch (currentScreen) {
      case 'HOME':
        return <HomeScreen 
          onNavigate={navigateTo} 
          onSelectPersona={(persona) => {
            setSessionData({ persona });
            navigateTo(Screen.PersonaDetail);
          }}
        />;
      
      case 'CHAT_TAB':
        return (
          <ChatTabScreen 
            onNavigate={navigateTo}
            onSelectPersona={(persona) => {
              // Í≤åÏä§Ìä∏Îäî ÏµúÎåÄ 3Î≤àÏùò ÎåÄÌôîÎßå Í∞ÄÎä•
              if (isGuest) {
                const guestChatCount = parseInt(localStorage.getItem('guestChatCount') || '0');
                if (guestChatCount >= 3) {
                  requireAuth();
                  return;
                }
              }
              setSessionData({ persona });
              navigateTo(Screen.PersonaDetail);
            }}
          />
        );
      
      case Screen.ConversationPrep:
        return (
          <ConversationPrepScreen
            partner={sessionData?.partner}
            onStart={(mode) => {
              setSessionData({ ...sessionData, conversationMode: mode, isTutorial: sessionData?.isTutorial || false });
              navigateTo(Screen.Chat);
            }}
            onBack={() => navigateTo('CHAT_TAB')}
          />
        );
      
      case Screen.Chat:
        return (
          <ChatScreen
            partner={sessionData?.partner}
            isTutorial={sessionData?.isTutorial || false}
            isCoaching={sessionData?.isCoaching || false}
            conversationMode={sessionData?.conversationMode || 'normal'}
            userProfile={user} // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Ï†ÑÎã¨
            onComplete={async (analysis, tutorialCompleted) => {
              if (tutorialCompleted && user) {
                // ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å Ïãú Ï≤òÎ¶¨
                const updatedProfile = { ...user, isTutorialCompleted: true };
                setUser(updatedProfile);
                
                if (isGuest) {
                  // Í≤åÏä§Ìä∏ ÏÇ¨Ïö©ÏûêÏùò ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å ÏÉÅÌÉú Ï†ÄÏû•
                  localStorage.setItem('guestTutorialCompleted', 'true');
                } else {
                  // ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÎäî ÏÑúÎ≤ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏
                  localStorage.setItem('userProfile', JSON.stringify(updatedProfile));
                  const userId = localStorage.getItem('userId');
                  if (userId) {
                    try {
                      const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:4000/api/v1';
                      await fetch(`${API_URL}/users/${userId}/tutorial/complete`, {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                      });
                    } catch (error) {
                      console.error('Failed to update tutorial status:', error);
                    }
                  }
                }
                
                // ÌôàÏúºÎ°ú Ïù¥Îèô
                setSessionData(null);
                navigateTo('HOME');
              } else {
                // ÏùºÎ∞ò ÎåÄÌôî ÏôÑÎ£å Ïãú
                if (isGuest && !sessionData?.isTutorial) {
                  // Í≤åÏä§Ìä∏ Ï±ÑÌåÖ ÌöüÏàò Ï¶ùÍ∞Ä
                  const currentCount = parseInt(localStorage.getItem('guestChatCount') || '0');
                  localStorage.setItem('guestChatCount', (currentCount + 1).toString());
                }
                // ÏùºÎ∞ò ÎåÄÌôî ÏôÑÎ£å Ïãú Î∂ÑÏÑù ÌôîÎ©¥ÏúºÎ°ú
                setSessionData({ ...sessionData, analysis, tutorialCompleted });
                navigateTo(Screen.ConversationAnalysis);
              }
            }}
          />
        );
      
      case Screen.ConversationAnalysis:
        // partnerÍ∞Ä AICoachÏù∏ÏßÄ ÌôïÏù∏ (specialty ÏÜçÏÑ± Ïú†Î¨¥Î°ú ÌåêÎã®)
        const isCoachChat = sessionData?.partner && 'specialty' in sessionData.partner;
        return (
          <ConversationAnalysisScreen
            analysis={sessionData?.analysis}
            tutorialJustCompleted={sessionData?.tutorialCompleted}
            onHome={() => navigateTo('HOME')}
            onBack={() => navigateTo(isCoachChat ? 'COACHING_TAB' : 'CHAT_TAB')}
          />
        );
      
      case Screen.PersonaDetail:
        return (
          <PersonaDetailScreen
            persona={sessionData?.persona}
            onBack={() => navigateTo('CHAT_TAB')}
            onStartChat={(persona) => {
              // ÌäúÌÜ†Î¶¨Ïñº Î™®ÎìúÏù∏ Í≤ΩÏö∞ isTutorial Ïú†ÏßÄ
              const isTutorialMode = sessionData?.isTutorial || false;
              setSessionData({ partner: persona, isTutorial: isTutorialMode });
              navigateTo(Screen.ConversationPrep);
            }}
          />
        );
      
      case Screen.CustomPersona:
        return (
          <CustomPersonaForm
            onCancel={() => navigateTo('CHAT_TAB')}
          />
        );
      
      case Screen.TutorialIntro:
        // sessionDataÏóêÏÑú ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇò Í∞ÄÏ†∏Ïò§Í∏∞
        const tutorialPartner = sessionData?.partner;
        
        // üöÄ ÌéòÎ•¥ÏÜåÎÇò Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÏóêÎü¨ ÌôîÎ©¥ ÌëúÏãú
        if (!tutorialPartner) {
          return (
            <div className="h-full w-full flex flex-col items-center justify-center bg-white">
              <div className="text-center p-8">
                <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                  <span className="text-2xl">‚ö†Ô∏è</span>
                </div>
                <h2 className="text-xl font-bold text-gray-800 mb-2">ÌéòÎ•¥ÏÜåÎÇò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§</h2>
                <p className="text-gray-600 mb-6">ÌäúÌÜ†Î¶¨ÏñºÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.</p>
                <button 
                  onClick={() => navigateTo('HOME')}
                  className="px-6 py-3 bg-[#0AC5A8] text-white rounded-lg font-medium hover:bg-[#08A693] transition-colors"
                >
                  ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
              </div>
            </div>
          );
        }
        
        return (
          <TutorialIntroScreen
            persona={tutorialPartner}
            onBack={() => navigateTo('HOME')}
            onComplete={() => {
              // ÌäúÌÜ†Î¶¨Ïñº ÌéòÎ•¥ÏÜåÎÇòÎ•º ÏÑ§Ï†ïÌïòÍ≥† ÌäúÌÜ†Î¶¨Ïñº Î™®ÎìúÎ°ú ÌëúÏãú
              setSessionData({ partner: tutorialPartner, isTutorial: true });
              navigateTo(Screen.PersonaDetail);
            }}
          />
        );
      
      case 'PERSONA_SELECTION':
        return (
          <PersonaSelection
            personas={[]}
            userProfile={user!}
            onSelect={() => {
              // Handle persona selection
              navigateTo('CHAT_TAB');
            }}
            onBack={() => navigateTo('HOME')}
          />
        );
      
      case 'PERSONA_RECOMMENDATION_INTRO':
        return (
          <PersonaRecommendationIntro
            onContinue={() => navigateTo('PERSONA_SELECTION')}
          />
        );
      
      case 'COACHING_TAB':
        return (
          <CoachingTabScreen 
            onNavigate={navigateTo}
            onStartCoachChat={(coach) => {
              // Í≤åÏä§Ìä∏Îäî ÏΩîÏπ≠ Í∏∞Îä• ÏÇ¨Ïö© Î∂àÍ∞Ä
              if (isGuest) {
                requireAuth();
                return;
              }
              // ÏΩîÏπòÏôÄÏùò Ï±ÑÌåÖ ÏãúÏûë (ÌîÑÎ†â ÌôîÎ©¥ Í±¥ÎÑàÎõ∞Í≥† Î∞îÎ°ú Ï±ÑÌåÖÏúºÎ°ú)
              setSessionData({ partner: coach, isTutorial: false, isCoaching: true });
              navigateTo(Screen.Chat);
            }}
          />
        );
      
      case Screen.StylingCoach:
        return <StylingCoach onBack={() => navigateTo('COACHING_TAB')} />;
      
      case Screen.LearningGoals:
        return (
          <LearningGoalsScreen
            onBack={() => navigateTo('MY_TAB')}
          />
        );
      
      case 'MY_TAB':
        return (
          <MyTabScreen 
            onNavigate={(screen) => {
              // Í≤åÏä§Ìä∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÌäπÏ†ï Í∏∞Îä•Ïóê Ï†ëÍ∑ºÌïòÎ†§ Ìï† Îïå ÌöåÏõêÍ∞ÄÏûÖ Ïú†ÎèÑ
              const restrictedScreens = [Screen.Badges, Screen.Favorites, Screen.LearningGoals];
              if (isGuest && restrictedScreens.includes(screen)) {
                requireAuth();
                return;
              }
              navigateTo(screen);
            }}
            onLogout={() => {
              if (isGuest) {
                // Í≤åÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                localStorage.removeItem('guestId');
                localStorage.removeItem('guestGender');
                localStorage.removeItem('guestPartnerGender');
                localStorage.removeItem('guestExperience');
                localStorage.removeItem('guestConfidence');
                localStorage.removeItem('guestDifficulty');
                localStorage.removeItem('guestInterests');
                localStorage.removeItem('guestTutorialCompleted');
                localStorage.removeItem('guestChatCount');
                localStorage.removeItem('hasCompletedOnboarding');
                setUser(null);
                setIsGuest(false);
                setAppState('onboarding');
                navigateTo('ONBOARDING');
              } else {
                // ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê Î°úÍ∑∏ÏïÑÏõÉ
                localStorage.removeItem('authToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('userProfile');
                setUser(null);
                setAppState('auth');
                navigateTo(Screen.LOGIN);
              }
            }}
            isGuest={isGuest}
          />
        );
      
      case Screen.ProfileEdit:
        return (
          <ProfileEditScreen
            userProfile={user!}
            onBack={() => navigateTo('MY_TAB')}
            onSave={(profile) => {
              setUser(profile);
              navigateTo('MY_TAB');
            }}
          />
        );
      
      case 'SETTINGS':
        return (
          <SettingsScreen
            onBack={() => navigateTo('MY_TAB')}
            onNavigate={navigateTo}
            onLogout={() => {
              // Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨
              localStorage.removeItem('authToken');
              localStorage.removeItem('refreshToken');
              localStorage.removeItem('userId');
              localStorage.removeItem('userProfile');
              setUser(null);
              setAppState('auth');
              navigateTo(Screen.LOGIN);
            }}
          />
        );
      
      case Screen.Badges:
        return <BadgesContainer onBack={() => navigateTo(previousScreen)} />;
      
      case Screen.Favorites:
        const favoritePersonas: any[] = []; // TODO: Load from API
        return (
          <FavoritesScreen
            personas={favoritePersonas}
            onBack={() => navigateTo('MY_TAB')}
            onSelectPersona={(persona) => {
              setSessionData({ persona });
              navigateTo(Screen.PersonaDetail);
            }}
          />
        );
      
      case Screen.NotificationSettings:
        return (
          <NotificationSettingsScreen
            onBack={() => navigateTo('SETTINGS')}
            notificationTime={localStorage.getItem('notificationTime') || '19:00'}
            doNotDisturbStart={localStorage.getItem('doNotDisturbStart') || '22:00'}
            doNotDisturbEnd={localStorage.getItem('doNotDisturbEnd') || '08:00'}
            onSave={(notificationTime, doNotDisturbStart, doNotDisturbEnd) => {
              localStorage.setItem('notificationTime', notificationTime);
              localStorage.setItem('doNotDisturbStart', doNotDisturbStart);
              localStorage.setItem('doNotDisturbEnd', doNotDisturbEnd);
            }}
          />
        );
      
      case Screen.DeleteAccount:
        return (
          <DeleteAccountScreen
            onBack={() => navigateTo('SETTINGS')}
            onComplete={() => {
              localStorage.clear();
              setUser(null);
              setAppState('onboarding');
            }}
          />
        );
      
      case Screen.PerformanceDetail:
        return (
          <PerformanceDetailScreen
            onBack={() => navigateTo('HOME')}
          />
        );
      
      case Screen.DataExport:
        return <DataExportScreen onBack={() => navigateTo('SETTINGS')} />;
      
      case Screen.DesignGuide:
        return <DesignGuideScreen onBack={() => navigateTo('MY_TAB')} />;
      
      default:
        return <HomeScreen onNavigate={navigateTo} />;
    }
  };

  if (appState === 'loading') {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto mb-4"></div>
          <p className="text-gray-600">Î°úÎî© Ï§ë...</p>
        </div>
      </div>
    );
  }

  // Ïù∏Ï¶ù ÌôîÎ©¥
  if (appState === 'auth') {
    switch (currentScreen) {
      case 'AUTH_CALLBACK':
        return <AuthCallback onNavigate={navigateTo} />;
      
      case Screen.SIGNUP:
        return (
          <SignupScreen
            onNavigate={navigateTo}
            onSignupSuccess={(userData) => {
              if (userData.profile) {
                setUser(userData.profile);
                localStorage.setItem('userProfile', JSON.stringify(userData.profile));
                setAppState('main');
                // ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å Ïó¨Î∂ÄÏóê Îî∞Îùº Îã§Î•∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
                if (!userData.profile.is_tutorial_completed) {
                  navigateTo(Screen.TutorialIntro);
                } else {
                  navigateTo('HOME');
                }
              } else {
                setAppState('onboarding');
                navigateTo('ONBOARDING');
              }
            }}
          />
        );
      
      case Screen.LOGIN:
      default:
        return (
          <LoginScreen
            onNavigate={navigateTo}
            onLoginSuccess={(userData) => {
              if (userData.profile) {
                setUser(userData.profile);
                localStorage.setItem('userProfile', JSON.stringify(userData.profile));
                setAppState('main');
                // ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å Ïó¨Î∂ÄÏóê Îî∞Îùº Îã§Î•∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
                if (!userData.profile.is_tutorial_completed) {
                  navigateTo(Screen.TutorialIntro);
                } else {
                  navigateTo('HOME');
                }
              } else {
                setAppState('onboarding');
                navigateTo('ONBOARDING');
              }
            }}
          />
        );
    }
  }

  if (appState === 'onboarding') {
    return <OnboardingFlow onComplete={handleOnboardingComplete} />;
  }

  const showBottomNav = [
    'HOME',
    'CHAT_TAB',
    'COACHING_TAB',
    'MY_TAB'
  ].includes(currentScreen as string);

  return (
    <div className="flex flex-col h-screen w-full max-w-md mx-auto bg-white">
      <div className="flex-1 overflow-hidden">
        {renderScreen()}
      </div>
      {showBottomNav && (
        <BottomNavBar
          activeTab={String(currentScreen)}
          onTabChange={navigateTo}
        />
      )}
    </div>
  );
};

const App: React.FC = () => {
  return (
    <QueryClientProvider client={queryClient}>
      <Providers>
        <AppContent />
      </Providers>
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
};

export default App;